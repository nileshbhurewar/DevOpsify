# roles/argocd/tasks/main.yml

- name: Check if kubectl is configured and cluster is accessible
  command: kubectl cluster-info
  register: cluster_check
  changed_when: false
  failed_when: cluster_check.rc != 0

- name: Create namespace for ArgoCD
  k8s:
    api_version: v1
    kind: Namespace
    name: argocd
    state: present
  ignore_errors: yes

- name: Install ArgoCD in EKS
  command: kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

- name: Wait for ArgoCD deployments to be available
  command: kubectl wait --for=condition=available deployment -l app.kubernetes.io/part-of=argocd -n argocd --timeout=300s
  ignore_errors: yes

- name: Expose ArgoCD Server (LoadBalancer)
  command: > 
    kubectl patch svc argocd-server -n argocd -p "{\"spec\": {\"type\": \"LoadBalancer\"}}"


- name: Wait for LoadBalancer to be provisioned
  shell: |
    timeout 300 bash -c 'while [ -z "$(kubectl get svc argocd-server -n argocd -o jsonpath='\''{.status.loadBalancer.ingress[0].hostname}'\'' 2>/dev/null)" ]; do sleep 10; echo "Waiting for LoadBalancer..."; done'
    kubectl get svc argocd-server -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
  register: lb_url
  args:
    executable: /bin/bash
  failed_when: lb_url.rc != 0
  retries: 3
  delay: 30

- name: Get ArgoCD admin password
  shell: |
    # Wait for the secret to be created
    until kubectl get secret argocd-initial-admin-secret -n argocd &>/dev/null; do sleep 5; done
    kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
  register: argocd_password
  args:
    executable: /bin/bash
  changed_when: false
  retries: 5
  delay: 10

- name: Display ArgoCD access information
  debug:
    msg: |
      ğŸš€ ArgoCD deployed successfully!
      
      ğŸ“ Access URL: http://{{ lb_url.stdout }}:80
      ğŸ‘¤ Username: admin
      ğŸ”‘ Password: {{ argocd_password.stdout }}
      
      ğŸ’¡ Quick access commands:
      kubectl get svc argocd-server -n argocd
      kubectl get pods -n argocd

